name: BTC Lottery

on:
  schedule:
    - cron: "0 9 * * *"
  workflow_dispatch:

env:
  POOL_SIZE: 15      # ä¿®æ”¹ä¸º15
  WINNER_COUNT: 2    # ä¿®æ”¹ä¸º2

jobs:
  lottery:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Fetch BTC Latest Block Hash
        id: fetch-hash
        run: |
          response=$(curl -s https://blockchain.info/latestblock)
          block_hash=$(echo $response | jq -r '.hash')
          echo "block_hash=$block_hash" >> $GITHUB_OUTPUT
          echo "## ðŸ”— åŒºå—ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- åŒºå—å“ˆå¸Œï¼š\`$block_hash\`" >> $GITHUB_STEP_SUMMARY

      - name: Perform Lottery
        id: lottery
        run: |
          POOL_SIZE=${{ env.POOL_SIZE }}
          WINNER_COUNT=${{ env.WINNER_COUNT }}
          BLOCK_HASH="${{ steps.fetch-hash.outputs.block_hash }}"
          SEED=$((0x${BLOCK_HASH: -8}))
          echo "seed=$SEED" >> $GITHUB_OUTPUT
          
          echo "import random" > lottery.py
          echo "import json" >> lottery.py
          echo "" >> lottery.py
          echo "pool_size = ${POOL_SIZE}" >> lottery.py
          echo "winner_count = ${WINNER_COUNT}" >> lottery.py
          echo "seed = ${SEED}" >> lottery.py
          echo "" >> lottery.py
          echo "random.seed(seed)" >> lottery.py
          echo "winners = random.sample(range(1, pool_size + 1), winner_count)" >> lottery.py
          echo "" >> lottery.py
          echo "result = {" >> lottery.py
          echo "    \"winners\": winners," >> lottery.py
          echo "    \"seed\": seed," >> lottery.py
          echo "    \"pool_size\": pool_size," >> lottery.py
          echo "    \"winner_count\": winner_count" >> lottery.py
          echo "}" >> lottery.py
          echo "" >> lottery.py
          echo "with open('lottery_result.json', 'w') as f:" >> lottery.py
          echo "    json.dump(result, f)" >> lottery.py
          echo "" >> lottery.py
          echo "print(f\"ðŸŽ‰ æŠ½å¥–ç»“æžœï¼š{winners}\")" >> lottery.py
          echo "print(f\"winners_str={','.join(map(str, winners))}\")" >> lottery.py
          
          python3 lottery.py > output.txt
          
          # ä»Žè¾“å‡ºä¸­æå–winners_strå¹¶ä¿å­˜åˆ°GITHUB_OUTPUT
          winners_str=$(grep "winners_str=" output.txt | cut -d'=' -f2)
          echo "winners=$winners_str" >> $GITHUB_OUTPUT
          
          echo "## ðŸŽ² æŠ½å¥–ç»“æžœ" >> $GITHUB_STEP_SUMMARY
          echo "- å¥–æ± å¤§å°ï¼š$POOL_SIZE" >> $GITHUB_STEP_SUMMARY
          echo "- æŠ½å¥–æ•°é‡ï¼š$WINNER_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- éšæœºç§å­ï¼š$SEED" >> $GITHUB_STEP_SUMMARY
          echo "- ä¸­å¥–å·ç ï¼š$winners_str" >> $GITHUB_STEP_SUMMARY

      - name: Upload Results
        uses: actions/upload-artifact@v3
        with:
          name: lottery-results
          path: lottery_result.json
          retention-days: 90

      - name: Generate Result File
        run: |
          echo "# ðŸŽ² æŠ½å¥–ç»“æžœ ($(date '+%Y-%m-%d'))" > result.md
          echo "" >> result.md
          echo "## åŒºå—ä¿¡æ¯" >> result.md
          echo "- åŒºå—å“ˆå¸Œï¼š\`${{ steps.fetch-hash.outputs.block_hash }}\`" >> result.md
          echo "- éšæœºç§å­ï¼š${{ steps.lottery.outputs.seed }}" >> result.md
          echo "" >> result.md
          echo "## æŠ½å¥–ç»“æžœ" >> result.md
          echo "- å¥–æ± å¤§å°ï¼š${{ env.POOL_SIZE }}" >> result.md
          echo "- æŠ½å¥–æ•°é‡ï¼š${{ env.WINNER_COUNT }}" >> result.md
          echo "- ðŸŽ‰ ä¸­å¥–å·ç ï¼š${{ steps.lottery.outputs.winners }}" >> result.md
          echo "" >> result.md
          echo "> ç”Ÿæˆæ—¶é—´ï¼š$(date '+%Y-%m-%d %H:%M:%S')" >> result.md

      - name: Upload Result Summary
        uses: actions/upload-artifact@v3
        with:
          name: lottery-summary
          path: result.md
          retention-days: 90
